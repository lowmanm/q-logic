<div class="page-header">
  <h1>Agent Workspace</h1>
</div>

<!-- Step 1: Select Project + Agent Identity -->
@if (!selectedProject) {
  <div class="card">
    <h2 style="margin-bottom: 16px;">Select a Project</h2>
    @if (projects.length === 0 && !isLoading) {
      <p style="color: var(--text-secondary);">
        No projects provisioned yet. Go to Schema Designer to create one.
      </p>
    }
    <div class="project-grid">
      @for (project of projects; track project.source_id) {
        <div class="project-card" (click)="selectProject(project)">
          <h3>{{ project.project_name }}</h3>
          <p>{{ project.columns.length }} columns</p>
          <code>{{ project.table_name }}</code>
        </div>
      }
    </div>
  </div>
}

<!-- Step 2: Agent Task Panel -->
@if (selectedProject && !currentTask && !taskCompleted) {
  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
      <div>
        <h2>{{ selectedProject.project_name }}</h2>
        @if (queueStats) {
          <div class="queue-bar">
            <span class="badge badge-available">{{ queueStats.pending }} pending</span>
            <span class="badge badge-in-task">{{ queueStats.assigned }} assigned</span>
            <span class="badge badge-wrap-up">{{ queueStats.completed }} completed</span>
            @if (queueStats.skipped > 0) {
              <span class="badge" style="background: #f1f3f4; color: var(--text-secondary);">{{ queueStats.skipped }} skipped</span>
            }
          </div>
        }
      </div>
      <button class="btn" style="background: var(--bg);" (click)="backToProjects()">
        Back
      </button>
    </div>

    <div style="display: flex; gap: 16px; align-items: flex-end;">
      <div style="flex: 1;">
        <label style="display: block; font-size: 13px; color: var(--text-secondary); margin-bottom: 4px;">
          Working as
        </label>
        <select [(ngModel)]="selectedEmployeeId" style="width: 100%;">
          <option value="" disabled>Select your name...</option>
          @for (emp of employees; track emp.id) {
            <option [value]="emp.id">{{ emp.name }}</option>
          }
        </select>
      </div>
      <button
        class="btn btn-primary"
        style="height: 38px;"
        (click)="getNextTask()"
        [disabled]="!selectedEmployeeId || isLoading"
      >
        {{ isLoading ? 'Pulling...' : 'Get Next Task' }}
      </button>
    </div>
  </div>
}

<!-- Step 3: Working a Task -->
@if (currentTask && !taskCompleted) {
  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
      <h2>Current Task</h2>
      <span style="font-size: 13px; color: var(--text-secondary);">
        {{ currentTask.queue_depth }} remaining in queue
      </span>
    </div>

    @if (currentTask.screen_pop_url) {
      <div class="screen-pop-bar">
        <code>{{ currentTask.screen_pop_url }}</code>
        <button class="btn btn-success" style="padding: 4px 16px; margin-left: 12px;" (click)="openScreenPop()">
          Open in CRM
        </button>
      </div>
    }

    <table style="margin-top: 16px;">
      @for (col of getDisplayColumns(); track col.physical) {
        <tr>
          <th style="width: 200px;">{{ col.display }}</th>
          <td>{{ currentTask.record[col.physical] }}</td>
        </tr>
      }
    </table>

    <div style="margin-top: 24px; display: flex; gap: 12px;">
      <button
        class="btn btn-primary"
        (click)="completeTask()"
        [disabled]="isLoading"
      >
        Complete
      </button>
      <button
        class="btn btn-warning"
        (click)="skipTask()"
        [disabled]="isLoading"
      >
        Skip
      </button>
      <button class="btn" style="background: var(--bg);" (click)="backToProjects()">
        Exit Queue
      </button>
    </div>
  </div>
}

<!-- Step 4: Task completed â€” pull next -->
@if (taskCompleted) {
  <div class="card" style="text-align: center;">
    <h2 style="color: var(--success); margin-bottom: 16px;">Task Completed</h2>
    @if (queueStats) {
      <p style="color: var(--text-secondary); margin-bottom: 16px;">
        {{ queueStats.pending }} records remaining in queue
      </p>
    }
    <div style="display: flex; gap: 12px; justify-content: center;">
      <button class="btn btn-primary" (click)="getNextTask()" [disabled]="isLoading">
        {{ isLoading ? 'Pulling...' : 'Get Next Task' }}
      </button>
      <button class="btn" style="background: var(--bg);" (click)="backToProjects()">
        Exit Queue
      </button>
    </div>
  </div>
}

@if (isLoading && !selectedProject) {
  <div class="card" style="text-align: center;">
    <p>Loading...</p>
  </div>
}

@if (error) {
  <div class="card" style="border-color: var(--danger); background: #fce8e6; margin-top: 16px;">
    <p style="color: var(--danger);">{{ error }}</p>
  </div>
}
